// Vercel Serverless Function - YouTube Caption/Transcript Fetcher
// Uses youtube-transcript-plus for Node.js compatibility

import { getTranscript } from 'youtube-transcript-plus';

export default async function handler(req, res) {
  // Enable CORS
  res.setHeader('Access-Control-Allow-Credentials', true);
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,POST');
  res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

  // Handle preflight OPTIONS request
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }

  // Only allow POST requests
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed. Use POST.' });
  }

  try {
    const { videoId } = req.body;

    if (!videoId) {
      return res.status(400).json({ error: 'Missing required field: videoId' });
    }

    console.log(`Fetching captions for video: ${videoId}`);

    // Fetch transcript using youtube-transcript-plus
    // This package handles language selection and fallbacks automatically
    const transcript = await getTranscript(videoId);

    if (!transcript || transcript.length === 0) {
      return res.status(404).json({
        error: 'No captions available for this video',
        hasCaptions: false
      });
    }

    console.log(`Successfully fetched ${transcript.length} caption segments`);

    // Transform to expected format
    // youtube-transcript-plus returns: { text, duration, offset }
    const captions = transcript.map(item => ({
      start: item.offset / 1000, // Convert ms to seconds
      duration: item.duration / 1000, // Convert ms to seconds
      text: item.text.trim()
    }));

    return res.status(200).json({
      success: true,
      hasCaptions: true,
      language: 'en',
      isAutoGenerated: true,
      captions: captions,
      trackInfo: {
        language: 'English',
        isAutoGenerated: true
      }
    });

  } catch (error) {
    console.error('Caption extraction error:', error);

    // Check for common error messages
    if (error.message && (error.message.includes('Could not') || error.message.includes('No transcript'))) {
      return res.status(404).json({
        error: 'No captions available for this video',
        hasCaptions: false
      });
    }

    return res.status(500).json({
      error: 'Internal server error',
      message: error.message
    });
  }
}
