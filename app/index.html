<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baratie - AI Recipe Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1><s Baratie</h1>
            <p class="tagline">Your AI-Powered Recipe Assistant</p>
        </header>

        <!-- Stage 1: Chat Interface -->
        <div id="stage-capture" class="stage active">
            <div class="capture-container">
                <h2>Start Your Cooking Journey</h2>
                <p class="subtitle">Share a recipe URL or ask me to modify a recipe</p>

                <!-- Chat Interface -->
                <div class="chat-container">
                    <div id="chat-messages" class="chat-messages">
                        <div class="chat-message chat-message-assistant">
                            <div class="message-content">
                                <p>Hi! I can help you extract recipes from URLs or modify existing recipes. Try saying:</p>
                                <ul class="chat-examples">
                                    <li>"https://example.com/recipe"</li>
                                    <li>"Make this recipe vegetarian: https://example.com/recipe"</li>
                                    <li>"Make this recipe gluten-free: [url]"</li>
                                    <li>"Double the servings for: [url]"</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="chat-input-container">
                        <textarea
                            id="chat-input"
                            class="chat-input"
                            placeholder="Paste a recipe URL or ask me to modify a recipe..."
                            rows="2"
                            aria-label="Recipe chat input"
                        ></textarea>
                        <button id="chat-send-btn" class="btn-primary chat-send-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="status-message" class="status-message"></div>
            </div>
        </div>

        <!-- Stage 2: Recipe Preview & Confirmation -->
        <div id="stage-preview" class="stage">
            <div class="preview-container">
                <button id="back-to-capture" class="btn-back">ÔøΩ Back</button>

                <div class="recipe-preview">
                    <h2 id="preview-title">Recipe Title</h2>
                    <p class="recipe-source">Source: <span id="preview-source"></span></p>

                    <div class="preview-meta">
                        <span id="preview-servings" class="meta-item">Servings: 4</span>
                        <span id="preview-ingredient-count" class="meta-item">15 ingredients</span>
                    </div>

                    <div class="preview-ingredients">
                        <h3>Ingredients Preview</h3>
                        <ul id="preview-ingredient-list"></ul>
                    </div>

                    <button id="start-cooking-btn" class="btn-primary btn-large">Start Cooking</button>
                </div>
            </div>
        </div>

        <!-- Stage 3: Interactive Cooking Interface -->
        <div id="stage-cooking" class="stage">
            <div class="cooking-container">
                <!-- Utility Panel -->
                <div class="utility-panel">
                    <button id="back-to-start" class="btn-secondary">ÔøΩ New Recipe</button>
                    <button id="download-pdf" class="btn-secondary">=ÔøΩ Download PDF</button>
                </div>

                <!-- Recipe Header -->
                <div class="recipe-header">
                    <h2 id="cooking-title">Recipe Title</h2>
                    <p class="recipe-source">Source: <span id="cooking-source"></span></p>
                </div>

                <!-- Servings Display (Read-only) -->
                <div class="servings-display">
                    <span class="servings-label">Servings:</span>
                    <span id="recipe-servings-count" class="servings-count">4</span>
                    <span class="servings-note">(Adjust via chat assistant)</span>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Progress: <span id="progress-text">0/0</span></span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                </div>

                <!-- Serving Adjuster (Hidden, kept for compatibility) -->
                <div class="serving-adjuster" style="display: none;">
                    <label for="servings-input">Servings:</label>
                    <div class="adjuster-controls">
                        <button id="decrease-servings" class="btn-adjuster"></button>
                        <input
                            type="number"
                            id="servings-input"
                            value="4"
                            min="1"
                            max="50"
                            aria-label="Number of servings"
                        >
                        <button id="increase-servings" class="btn-adjuster">+</button>
                    </div>
                    <span id="original-servings" class="serving-note">Original: 4 servings</span>
                </div>

                <!-- Recipe/Macros Tabs -->
                <div class="recipe-tabs">
                    <button class="tab-button active" data-tab="recipe">Recipe</button>
                    <button class="tab-button" data-tab="macros">Nutrition</button>
                </div>

                <!-- Recipe Tab Content -->
                <div id="recipe-tab" class="tab-content active">
                    <!-- Ingredients Section -->
                    <div class="ingredients-section">
                        <h3>Ingredients</h3>
                        <ul id="cooking-ingredient-list"></ul>
                    </div>

                    <!-- Instructions Section -->
                    <div class="instructions-section">
                        <h3>Instructions</h3>
                        <div id="cooking-instructions-list"></div>
                    </div>
                </div>

                <!-- Macros Tab Content -->
                <div id="macros-tab" class="tab-content">
                    <div class="macros-section">
                        <div class="macros-header">
                            <h3>Nutrition Information</h3>
                            <div class="macros-serving-selector">
                                <label for="macros-servings-input">Divide recipe into:</label>
                                <div class="macros-adjuster-controls">
                                    <button id="macros-decrease-servings" class="btn-adjuster">‚àí</button>
                                    <input
                                        type="number"
                                        id="macros-servings-input"
                                        value="1"
                                        min="1"
                                        max="50"
                                        aria-label="Number of portions to divide recipe into"
                                    >
                                    <button id="macros-increase-servings" class="btn-adjuster">+</button>
                                    <span class="macros-serving-label">portion(s)</span>
                                </div>
                            </div>
                            <p class="macros-serving-info">Nutrition shown per portion (original recipe: <span id="recipe-total-servings">4</span> servings)</p>
                        </div>

                        <div id="macros-loading" class="macros-loading">
                            <div class="spinner"></div>
                            <p>Calculating nutrition information...</p>
                        </div>

                        <div id="macros-content" class="macros-content" style="display: none;">
                            <!-- Calorie Summary -->
                            <div class="macro-calories">
                                <div class="calories-circle">
                                    <span id="total-calories" class="calories-number">0</span>
                                    <span class="calories-label">calories</span>
                                </div>
                            </div>

                            <!-- Macronutrients -->
                            <div class="macros-grid">
                                <div class="macro-card protein">
                                    <div class="macro-icon">ü•©</div>
                                    <div class="macro-info">
                                        <span class="macro-label">Protein</span>
                                        <span class="macro-value"><span id="protein-grams">0</span>g</span>
                                        <span class="macro-percentage"><span id="protein-percentage">0</span>%</span>
                                    </div>
                                </div>

                                <div class="macro-card carbs">
                                    <div class="macro-icon">üçû</div>
                                    <div class="macro-info">
                                        <span class="macro-label">Carbs</span>
                                        <span class="macro-value"><span id="carbs-grams">0</span>g</span>
                                        <span class="macro-percentage"><span id="carbs-percentage">0</span>%</span>
                                    </div>
                                </div>

                                <div class="macro-card fats">
                                    <div class="macro-icon">ü•ë</div>
                                    <div class="macro-info">
                                        <span class="macro-label">Fats</span>
                                        <span class="macro-value"><span id="fats-grams">0</span>g</span>
                                        <span class="macro-percentage"><span id="fats-percentage">0</span>%</span>
                                    </div>
                                </div>

                                <div class="macro-card fiber">
                                    <div class="macro-icon">üåæ</div>
                                    <div class="macro-info">
                                        <span class="macro-label">Fiber</span>
                                        <span class="macro-value"><span id="fiber-grams">0</span>g</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Nutrients -->
                            <div class="nutrients-list">
                                <h4>Additional Nutrients</h4>
                                <div class="nutrient-row">
                                    <span>Sodium</span>
                                    <span id="sodium-mg">0</span>
                                </div>
                                <div class="nutrient-row">
                                    <span>Sugar</span>
                                    <span id="sugar-grams">0</span>
                                </div>
                                <div class="nutrient-row">
                                    <span>Cholesterol</span>
                                    <span id="cholesterol-mg">0</span>
                                </div>
                            </div>

                            <div class="macros-disclaimer">
                                <small>* Nutritional values are estimates calculated by AI and may vary based on specific ingredients and preparation methods.</small>
                            </div>
                        </div>

                        <div id="macros-error" class="macros-error" style="display: none;">
                            <p>Unable to calculate nutrition information. Please try again.</p>
                            <button id="recalculate-macros" class="btn-secondary">Recalculate</button>
                        </div>
                    </div>
                </div>

                <!-- Chat Assistant -->
                <div class="chat-assistant">
                    <div class="chat-header">
                        <span>=ÔøΩ Ask Me Anything</span>
                        <button id="toggle-chat" class="btn-icon"></button>
                    </div>
                    <div id="cooking-chat-messages" class="chat-messages"></div>
                    <div class="chat-input-container">
                        <input
                            type="text"
                            id="cooking-chat-input"
                            placeholder="Ask about substitutions, techniques, or timing..."
                            aria-label="Cooking chat input"
                        >
                        <button id="send-chat" class="btn-primary">Send</button>
                    </div>
                </div>

                <!-- Quota Tracker -->
                <div id="quota-tracker" class="quota-tracker">
                    <!-- Content will be dynamically generated by updateQuotaUI() -->
                </div>

                <!-- Cooking Timer Widget (top-right, fixed position) -->
                <div id="timer-widget" class="timer-widget minimized">
                    <div class="timer-header">
                        <span>üç≥ Cooking Timer</span>
                        <button id="timer-minimize-btn" class="timer-minimize-btn">‚àí</button>
                    </div>
                    <div class="timer-content">
                        <div class="timer-display">
                            <span id="timer-hours" class="timer-digit">00</span>
                            <span class="timer-separator">:</span>
                            <span id="timer-minutes" class="timer-digit">00</span>
                            <span class="timer-separator">:</span>
                            <span id="timer-seconds" class="timer-digit">00</span>
                        </div>
                        <input
                            type="text"
                            id="timer-note"
                            class="timer-note"
                            placeholder="Timer note (optional)"
                            maxlength="50"
                            aria-label="Timer note"
                        >
                        <div class="timer-controls">
                            <button id="timer-subtract-5" class="timer-btn timer-btn-secondary" aria-label="Subtract 5 minutes">-5m</button>
                            <button id="timer-add-5" class="timer-btn timer-btn-secondary" aria-label="Add 5 minutes">+5m</button>
                            <button id="timer-toggle" class="timer-btn timer-btn-primary" aria-label="Start timer">Start</button>
                            <button id="timer-reset" class="timer-btn timer-btn-secondary" aria-label="Reset timer">Reset</button>
                        </div>
                        <div id="timer-status" class="timer-status"></div>
                    </div>
                </div>

                <!-- Timer Complete Modal -->
                <div id="timer-modal" class="timer-modal hidden">
                    <div class="timer-modal-overlay"></div>
                    <div class="timer-modal-content">
                        <div class="timer-modal-header">
                            <h3>‚è∞ Timer Complete!</h3>
                        </div>
                        <div class="timer-modal-body">
                            <p id="timer-modal-note" class="timer-modal-note"></p>
                        </div>
                        <div class="timer-modal-footer">
                            <button id="timer-modal-dismiss" class="btn-primary">Dismiss</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Extension Data Detection -->
    <script>
        // Check for browser extension-passed data on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);

            if (urlParams.has('recipe_text') || urlParams.has('recipe_storage_id') || urlParams.has('recipe_url')) {
                // Store extension data globally for app.js to access
                window.extensionData = {
                    text: urlParams.get('recipe_text') ? decodeURIComponent(urlParams.get('recipe_text')) : null,
                    storageId: urlParams.get('recipe_storage_id'),
                    url: urlParams.get('recipe_url') ? decodeURIComponent(urlParams.get('recipe_url')) : null,
                    sourceUrl: urlParams.get('source_url') ? decodeURIComponent(urlParams.get('source_url')) : 'Browser Extension Capture'
                };

                console.log('Extension data detected:', {
                    hasText: !!window.extensionData.text,
                    hasStorageId: !!window.extensionData.storageId,
                    hasUrl: !!window.extensionData.url,
                    sourceUrl: window.extensionData.sourceUrl
                });
            }
        })();
    </script>

    <!-- Load config (serverless endpoints - no API keys in client code) -->
    <script src="config.prod.js"></script>
    <script src="app.js"></script>
</body>
</html>
